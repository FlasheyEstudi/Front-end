<div class="detalle-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Gesti√≥n de Pagos</h1>
    <p>Controla los desembolsos y calendario de pagos de becas</p>
  </div>

  <!-- Mensajes -->
  <div *ngIf="errorMsg" class="error-message">{{ errorMsg }}</div>
  <div *ngIf="successMsg" class="success-message">{{ successMsg }}</div>

  <!-- Botones principales -->
  <div class="action-buttons">
    <button class="btn-export" (click)="exportToPDF()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 15v2m-6-4h12m-6-8V3m-3 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Exportar Reporte PDF
    </button>
    <button class="btn-process" (click)="openProcessPaymentModal()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Procesar Pago
    </button>
  </div>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card green">
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-content">
        <h2>{{ dashboardData.totalPagado | currency:'USD':'symbol':'1.2-2' }}</h2>
        <p>Total Pagado</p>
        <small>Desembolsado</small>
      </div>
    </div>
    <div class="kpi-card red">
      <div class="kpi-icon">‚è∞</div>
      <div class="kpi-content">
        <h2>{{ dashboardData.totalPendiente | currency:'USD':'symbol':'1.2-2' }}</h2>
        <p>Total Pendiente</p>
        <small>Por pagar</small>
      </div>
    </div>
    <div class="kpi-card blue">
      <div class="kpi-icon">üë•</div>
      <div class="kpi-content">
        <h2>{{ dashboardData.beneficiariosActivos }}</h2>
        <p>Becarios Activos</p>
        <small>Beneficiarios</small>
      </div>
    </div>
    <div class="kpi-card purple">
      <div class="kpi-icon">üìà</div>
      <div class="kpi-content">
        <h2>{{ dashboardData.presupuestoTotal | currency:'USD':'symbol':'1.2-2' }}</h2>
        <p>Presupuesto Total</p>
        <small>Total</small>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-container">
    <button class="tab-button" (click)="activeTab = 'control'" [class.active]="activeTab === 'control'">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 4v16M4 12h16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Control de Pagos
    </button>
    <button class="tab-button" (click)="activeTab = 'calendar'" [class.active]="activeTab === 'calendar'">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7.414a2 2 0 00-.586-1.414l-5.414-5.414A2 2 0 0012.586 1H8a2 2 0 00-2 2v14a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Calendario de Pagos
    </button>
    <button class="tab-button" (click)="activeTab = 'history'" [class.active]="activeTab === 'history'">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Historial
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Control de Pagos -->
    <div *ngIf="activeTab === 'control'">
      <div class="filters-container">
        <input type="text" placeholder="Buscar beneficiario..." class="search-input" [(ngModel)]="searchTerm" (input)="onSearch()">
        <select class="select-filter" [(ngModel)]="estadoFiltro" (change)="onFilterChange()">
          <option value="">Todos los estados</option>
          <option value="Activo">Activo</option>
          <option value="Completado">Completado</option>
          <option value="Pendiente">Pendiente</option>
        </select>
        <select class="select-filter" [(ngModel)]="periodoFiltro" (change)="onFilterChange()">
          <option value="">Todos los periodos</option>
          <option value="2025-I">2025-I</option>
          <option value="2025-II">2025-II</option>
        </select>
        <span class="filter-count">{{ filteredDetallesDePago.length }} registros</span>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Beneficiario</th>
              <th>Beca</th>
              <th>Monto Total</th>
              <th>Pagado</th>
              <th>Restante</th>
              <th>Pr√≥ximo Pago</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let detalle of filteredDetallesDePago">
              <td>
                <div class="avatar-container">
                  <div class="avatar">{{ getInitialFromReference(detalle.SolicitudBecaReferencia || 'N/A') }}</div>
                  <div class="student-name">{{ detalle.SolicitudBecaReferencia || 'N/A' }}</div>
                  <div class="student-id">{{ detalle.Id }}</div>
                </div>
              </td>
              <td>{{ detalle.TipoPagoNombre || 'N/A' }}</td>
              <td>{{ detalle.Monto | currency:'USD':'symbol':'1.2-2' }}</td>
              <td>
                <div class="progress-bar">
                  <div class="progress-fill" [style.width]="(detalle.Monto / 100000) * 100 + '%'"></div>
                  {{ detalle.Monto | currency:'USD':'symbol':'1.2-2' }}
                </div>
              </td>
              <td>
                <div class="amount" [class.pending]="detalle.Estadonombre !== 'Completado'">
                  {{ detalle.Monto | currency:'USD':'symbol':'1.2-2' }}
                </div>
              </td>
              <td>
                <div class="date">{{ detalle.FechaPago | date:'yyyy-MM-dd' }}</div>
                <div class="status">Programado</div>
              </td>
              <td>
                <span class="status-badge" [class.active]="detalle.Estadonombre === 'Activo'"
                      [class.completed]="detalle.Estadonombre === 'Completado'"
                      [class.pending]="detalle.Estadonombre === 'Pendiente'">
                  {{ detalle.Estadonombre || 'N/A' }}
                </span>
              </td>
              <td>
                <button class="btn-action view" (click)="openDetailsModal(detalle)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M12 15a3 3 0 100-6 3 3 0 000 6z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="btn-action edit" (click)="editDetallePago(detalle)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button class="btn-action delete" (click)="deleteDetallePago(detalle.Id)" [disabled]="loading">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m-4 5v6m-4-6v6m8-6v6M5 6l1 12a2 2 0 002 2h8a2 2 0 002-2l1-12H5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Calendario de Pagos -->
    <div *ngIf="activeTab === 'calendar'">
      <div class="calendar-item" *ngFor="let calendar of calendarioDePagos">
        <div class="date">
          <div class="date-icon">üìÖ</div>
          <div class="date-text">{{ calendar.fecha | date:'fullDate' }}</div>
          <div class="payments-count">{{ calendar.pagos.length }} pagos programados</div>
        </div>
        <div class="payment-details" *ngFor="let pago of calendar.pagos">
          <div class="beneficiario">
            <div class="avatar">{{ getInitialFromReference(pago.nombre) }}</div>
            <div class="name">{{ pago.nombre }}</div>
            <div class="codigo">BEC-{{ pago.id }}</div>
          </div>
          <div class="monto">{{ pago.monto | currency:'USD':'symbol':'1.2-2' }}</div>
          <div class="actions">
            <button class="btn-view" (click)="openDetailsModal({ 
              Id: pago.id, 
              SolicitudBecaId: 0, 
              TipoPagoId: 0, 
              Monto: pago.monto, 
              FechaPago: calendar.fecha, 
              Referencia: '', 
              EstadoId: 0, 
              SolicitudBecaReferencia: pago.nombre, 
              TipoPagoNombre: 'N/A', 
              Estadonombre: pago.estado 
            })">
              Ver Detalles
            </button>
            <button class="btn-process-lote">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Procesar Lote
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Historial -->
    <div *ngIf="activeTab === 'history'">
      <div class="historial-container">
        <div class="transaction-item" *ngFor="let tx of historialTransacciones">
          <div class="info">
            <div class="icon">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 15v2m-6-4h12m-6-8V3m-3 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="name">{{ tx.nombre }}</div>
            <div class="details">{{ tx.fecha | date:'dd/MM/yyyy' }} ‚Ä¢ {{ tx.metodo }}</div>
          </div>
          <div class="amount">{{ tx.monto | currency:'USD':'symbol':'1.2-2' }}</div>
          <div class="status-badge" [class.completed]="tx.estado === 'Pagado'">{{ tx.estado }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para procesar pago -->
  <div *ngIf="showProcessPaymentModal" class="modal-overlay" (click)="closeProcessPaymentModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Procesar Nuevo Pago</h3>
        <button class="close-button" (click)="closeProcessPaymentModal()">√ó</button>
      </div>
      <form (ngSubmit)="processPayment()" class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label for="estudiante">Estudiante Beneficiario *</label>
            <select id="estudiante" [(ngModel)]="selectedStudentId" name="estudiante" (change)="onEstudianteChange($event)" required>
              <option value="" disabled>Seleccionar estudiante...</option>
              <option *ngFor="let estudiante of estudiantesBeneficiados" [value]="estudiante.EstudianteId">
                {{ estudiante.Nombre }} {{ estudiante.Apellido }}
              </option>
            </select>
            <!-- Mensaje si no hay estudiantes disponibles -->
            <div *ngIf="!estudiantesBeneficiados.length" class="error-message">
              No hay estudiantes beneficiados disponibles. Verifique la conexi√≥n con el servidor.
            </div>
          </div>
          <div class="form-group">
            <label for="monto">Monto a Pagar *</label>
            <input type="number" id="monto" [(ngModel)]="montoAPagar" name="monto" required min="0" step="0.01">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="fechaPago">Fecha de Pago *</label>
            <input type="date" id="fechaPago" [(ngModel)]="fechaPago" name="fechaPago" required>
          </div>
          <div class="form-group">
            <label for="metodoPago">M√©todo de Pago *</label>
            <select id="metodoPago" [(ngModel)]="metodoPago" name="metodoPago" required>
              <option value="" disabled>Seleccionar m√©todo...</option>
              <option *ngFor="let tipo of tiposPagoLookup" [value]="tipo.Nombre">{{ tipo.Nombre }}</option>
            </select>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-secundario" (click)="closeProcessPaymentModal()">Cancelar</button>
          <button type="submit" class="btn-primario" [disabled]="loading">
            <span *ngIf="!loading">Procesar Pago</span>
            <span *ngIf="loading" class="loading-spinner"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para ver detalles -->
  <div *ngIf="showDetailsModal" class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalles del Pago</h3>
        <button class="close-button" (click)="closeDetailsModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="detail-item" *ngIf="selectedDetalle">
          <strong>Beneficiario:</strong> {{ selectedDetalle.SolicitudBecaReferencia || 'N/A' }}
        </div>
        <div class="detail-item" *ngIf="selectedDetalle">
          <strong>Fecha de Pago:</strong> {{ selectedDetalle.FechaPago | date:'dd/MM/yyyy' }}
        </div>
        <div class="detail-item" *ngIf="selectedDetalle">
          <strong>Monto:</strong> {{ selectedDetalle.Monto | currency:'USD':'symbol':'1.2-2' }}
        </div>
        <div class="detail-item" *ngIf="selectedDetalle">
          <strong>M√©todo:</strong> {{ selectedDetalle.TipoPagoNombre || 'N/A' }}
        </div>
        <div class="detail-item" *ngIf="selectedDetalle">
          <strong>Estado:</strong> {{ selectedDetalle.Estadonombre || 'N/A' }}
        </div>
        <div class="detail-item" *ngIf="selectedDetalle">
          <strong>Referencia:</strong> {{ selectedDetalle.Referencia || 'N/A' }}
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario para agregar/editar -->
  <div class="form-container">
    <h2>{{ editMode ? 'Editar Detalle de Pago' : 'Agregar Detalle de Pago' }}</h2>
    <form (ngSubmit)="guardarDetallePago()">
      <div class="form-row">
        <div class="form-group">
          <label for="solicitudBeca">Solicitud de Beca</label>
          <select id="solicitudBeca" [(ngModel)]="nuevoDetallePago.SolicitudBecaId" name="solicitudBeca" required>
            <option value="" disabled>Seleccionar solicitud...</option>
            <option *ngFor="let s of solicitudesBecaLookup" [value]="s.Id">{{ s.Referencia }}</option>
          </select>
        </div>
        <div class="form-group">
          <label for="tipoPago">Tipo de Pago</label>
          <select id="tipoPago" [(ngModel)]="nuevoDetallePago.TipoPagoId" name="tipoPago" required>
            <option value="" disabled>Seleccionar tipo...</option>
            <option *ngFor="let t of tiposPagoLookup" [value]="t.Id">{{ t.Nombre }}</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="monto">Monto</label>
          <input type="number" id="monto" [(ngModel)]="nuevoDetallePago.Monto" name="monto" required min="0" step="0.01">
        </div>
        <div class="form-group">
          <label for="fechaPago">Fecha de Pago</label>
          <input type="date" id="fechaPago" [(ngModel)]="nuevoDetallePago.FechaPago" name="fechaPago" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="referencia">Referencia</label>
          <input type="text" id="referencia" [(ngModel)]="nuevoDetallePago.Referencia" name="referencia">
        </div>
        <div class="form-group">
          <label for="estado">Estado</label>
          <select id="estado" [(ngModel)]="nuevoDetallePago.EstadoId" name="estado" required>
            <option value="" disabled>Seleccionar estado...</option>
            <option *ngFor="let e of estadosLookup" [value]="e.Id">{{ e.Nombre }}</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-secundario" (click)="cancelEdit()">Cancelar</button>
        <button type="submit" class="btn-primario" [disabled]="loading">
          <span *ngIf="!loading">{{ editMode ? 'Actualizar' : 'Agregar' }}</span>
          <span *ngIf="loading" class="loading-spinner"></span>
        </button>
      </div>
    </form>
  </div>
</div>