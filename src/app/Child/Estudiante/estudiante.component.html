<div class="estudiantes-contenido">
  <!-- Toast flotante con HTML -->
  <div *ngIf="showToast" class="toast toast-{{ toastType }}" [innerHTML]="toastMessage">
  </div>

  <!-- Mensajes de error -->
  <div *ngIf="error" class="form-group error-message">
    <span class="error-icon">⚠️</span>
    {{ error }}
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="loading" class="loading-overlay">
    <div class="spinner"></div>
    <p>Cargando...</p>
  </div>

  <!-- Header -->
  <div class="page-header">
    <h1>Gestión de Estudiantes</h1>
    <p>Administra y supervisa a los estudiantes registrados</p>
  </div>

  <!-- Botón Nuevo Estudiante -->
  <button class="btn-nuevo" (click)="abrirModalRegistro()" [disabled]="loading">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Nuevo Estudiante
  </button>

  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card green">
      <div class="kpi-icon">🎓</div>
      <div class="kpi-content">
        <h2>{{ totalEstudiantes }}</h2>
        <p>Estudiantes Registrados</p>
      </div>
    </div>
    <div class="kpi-card blue">
      <div class="kpi-icon">👤</div>
      <div class="kpi-content">
        <h2>{{ estudiantesActivos }}</h2>
        <p>Estudiantes Activos</p>
      </div>
    </div>
    <div class="kpi-card red">
      <div class="kpi-icon">📚</div>
      <div class="kpi-content">
        <h2>{{ carrerasDisponibles.length }}</h2>
        <p>Carreras Representadas</p>
      </div>
    </div>
    <div class="kpi-card purple">
      <div class="kpi-icon">⏰</div>
      <div class="kpi-content">
        <h2>{{ edadPromedio }}</h2>
        <p>Edad Promedio</p>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-container">
    <input 
      type="text" 
      placeholder="Buscar por nombre o correo..." 
      [(ngModel)]="searchTerm" 
      (input)="aplicarFiltros()" 
      class="search-input"
      [disabled]="loading">
    
    <select 
      [(ngModel)]="filtroEstado" 
      (change)="aplicarFiltros()" 
      class="select-filter"
      [disabled]="loading">
      <option value="">Todos los estados</option>
      <option *ngFor="let estado of estadosDisponibles" [value]="estado.Id.toString()">{{ estado.Nombre }}</option>
    </select>
    
    <select 
      [(ngModel)]="filtroCarrera" 
      (change)="aplicarFiltros()" 
      class="select-filter"
      [disabled]="loading">
      <option value="">Todas las carreras</option>
      <option *ngFor="let carrera of carrerasDisponibles" [value]="carrera.Id.toString()">{{ carrera.Nombre }}</option>
    </select>
    
    <button class="filter-button" (click)="aplicarFiltros()" [disabled]="loading">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00.707.293H18a1 1 0 011 1v3a1 1 0 01-1 1H8a1 1 0 01-1-1v-3a1 1 0 011-1h3.293a1 1 0 00.707-.293l6.414-6.414A1 1 0 0121 8.586V4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Filtros
    </button>
    
    <span class="filter-count">{{ filteredEstudiantes.length }} estudiantes</span>
  </div>

  <!-- Tabla de estudiantes -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table-modern">
        <thead>
          <tr>
            <th>Estudiante</th>
            <th>Edad</th>
            <th>Carrera</th>
            <th>Email</th>
            <th>Registro</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let estudiante of filteredEstudiantes; trackBy: trackByEstudiante">
            <td>
              <div class="avatar-container">
                <div class="avatar">{{ (estudiante.Nombre.charAt(0) || 'N') + (estudiante.Apellido.charAt(0) || 'A') }}</div>
                <div class="student-name">
                  <strong>{{ estudiante.Nombre }} {{ estudiante.Apellido }}</strong><br />
                  <small>{{ getBecasActivas(estudiante.Id) ? getBecasActivas(estudiante.Id) + ' beca(s) activa(s)' : 'Sin becas activas' }}</small>
                </div>
              </div>
            </td>
            <td>{{ estudiante.Edad }} años</td>
            <td>
              <div class="carrera-name">{{ getCarreraNombre(estudiante.CarreraId) }}</div>
              <div class="carrera-programa">{{ getProgramaNombre(estudiante.CarreraId) }}</div>
            </td>
            <td>{{ estudiante.Correo }}</td>
            <td>
              <span *ngIf="estudiante.FechaRegistro; else noFecha">
                {{ estudiante.FechaRegistro | date:'dd/MM/yyyy' }}
              </span>
              <ng-template #noFecha>No disponible</ng-template>
            </td>
            <td>
              <!-- Corrección: Usar EstadoId = 4 para "Activo" -->
              <span class="status-badge" [class.active]="estudiante.EstadoId === 4">
                {{ getEstadoNombre(estudiante.EstadoId) }}
              </span>
            </td>
            <td>
              <button class="btn-action view" (click)="verEstudiante(estudiante.Id)" title="Ver detalles">👁️</button>
              <button class="btn-action edit" (click)="editarEstudiante(estudiante.Id)" title="Editar">✏️</button>
              <button class="btn-action delete" (click)="deleteEstudiante(estudiante.Id)" [disabled]="loading" title="Eliminar">🗑️</button>
            </td>
          </tr>
          <tr *ngIf="filteredEstudiantes.length === 0 && !loading">
            <td colspan="7" class="no-results">
              No se encontraron estudiantes
            </td>
          </tr>
          <tr *ngIf="loading && filteredEstudiantes.length === 0">
            <td colspan="7" class="no-results">
              Cargando estudiantes...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal de Registro -->
  <div *ngIf="showModal" class="modal-overlay" (click)="cerrarModalRegistro()">
    <div class="modal-registro" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Registrar Nuevo Estudiante</h3>
        <button class="close-button" (click)="cerrarModalRegistro()" type="button">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onSubmitNewStudent()" #studentForm="ngForm">
          <div class="form-row">
            <div class="form-group">
              <label for="nombre">Nombre *</label>
              <input type="text" id="nombre" [(ngModel)]="nuevoEstudiante.Nombre" name="Nombre" required>
            </div>
            <div class="form-group">
              <label for="apellido">Apellido *</label>
              <input type="text" id="apellido" [(ngModel)]="nuevoEstudiante.Apellido" name="Apellido" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edad">Edad *</label>
              <input type="number" id="edad" [(ngModel)]="nuevoEstudiante.Edad" name="Edad" required min="1" max="120">
            </div>
            <div class="form-group">
              <label for="correo">Correo Electrónico *</label>
              <input type="email" id="correo" [(ngModel)]="nuevoEstudiante.Correo" name="Correo" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="estado">Estado</label>
              <select id="estado" [(ngModel)]="nuevoEstudiante.EstadoId" name="EstadoId">
                <option [ngValue]="null">Seleccione estado</option>
                <option *ngFor="let estado of estadosDisponibles" [value]="estado.Id">
                  {{ estado.Nombre }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="carrera">Carrera</label>
              <select id="carrera" [(ngModel)]="nuevoEstudiante.CarreraId" name="CarreraId">
                <option [ngValue]="null">Seleccione carrera</option>
                <option *ngFor="let carrera of carrerasDisponibles" [value]="carrera.Id">
                  {{ carrera.Nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secundario" (click)="cerrarModalRegistro()" [disabled]="loading">Cancelar</button>
            <button type="submit" class="btn-primario" [disabled]="studentForm.invalid || loading">
              <span *ngIf="!loading">Registrar Estudiante</span>
              <span *ngIf="loading" class="loading-spinner"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Edición -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="cerrarModalEdicion()">
    <div class="modal-editar" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Estudiante</h3>
        <button class="close-button" (click)="cerrarModalEdicion()" type="button">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onSubmitEditStudent()" #editForm="ngForm">
          <div class="form-row">
            <div class="form-group">
              <label for="edit-nombre">Nombre *</label>
              <input type="text" id="edit-nombre" [(ngModel)]="estudianteEdit.Nombre" name="Nombre" required>
            </div>
            <div class="form-group">
              <label for="edit-apellido">Apellido *</label>
              <input type="text" id="edit-apellido" [(ngModel)]="estudianteEdit.Apellido" name="Apellido" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edit-edad">Edad *</label>
              <input type="number" id="edit-edad" [(ngModel)]="estudianteEdit.Edad" name="Edad" required min="1" max="120">
            </div>
            <div class="form-group">
              <label for="edit-correo">Correo Electrónico *</label>
              <input type="email" id="edit-correo" [(ngModel)]="estudianteEdit.Correo" name="Correo" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edit-estado">Estado</label>
              <select id="edit-estado" [(ngModel)]="estudianteEdit.EstadoId" name="EstadoId">
                <option [ngValue]="null">Seleccione estado</option>
                <option *ngFor="let estado of estadosDisponibles" [value]="estado.Id">
                  {{ estado.Nombre }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-carrera">Carrera</label>
              <select id="edit-carrera" [(ngModel)]="estudianteEdit.CarreraId" name="CarreraId">
                <option [ngValue]="null">Seleccione carrera</option>
                <option *ngFor="let carrera of carrerasDisponibles" [value]="carrera.Id">
                  {{ carrera.Nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secundario" (click)="cerrarModalEdicion()" [disabled]="loading">Cancelar</button>
            <button type="submit" class="btn-primario" [disabled]="editForm.invalid || loading">
              <span *ngIf="!loading">Actualizar Estudiante</span>
              <span *ngIf="loading" class="loading-spinner"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal de Credenciales Generadas -->
  <div *ngIf="showCredentialsModal" class="modal-overlay" (click)="cerrarModalCredenciales()">
    <div class="modal-registro" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Credenciales del Estudiante</h3>
        <button class="close-button" (click)="cerrarModalCredenciales()" type="button">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success">
          <p>✅ ¡Estudiante creado exitosamente!</p>
        </div>
        <p>Estas son las credenciales temporales del estudiante:</p>
        <div class="credenciales-info">
          <div class="credencial-item">
            <label>Usuario:</label>
            <div class="credencial-value">
              <span>{{ credenciales.usuario }}</span>
              <button class="copy-button" (click)="copyToClipboard(credenciales.usuario, 'usuario')" title="Copiar usuario">📋</button>
            </div>
          </div>
          <div class="credencial-item">
            <label>Correo:</label>
            <div class="credencial-value">
              <span>{{ credenciales.correo }}</span>
              <button class="copy-button" (click)="copyToClipboard(credenciales.correo, 'correo')" title="Copiar correo">📋</button>
            </div>
          </div>
          <div class="credencial-item">
            <label>Contraseña temporal:</label>
            <div class="credencial-value">
              <span>{{ credenciales.contrasena }}</span>
              <button class="copy-button" (click)="copyToClipboard(credenciales.contrasena, 'contraseña')" title="Copiar contraseña">📋</button>
            </div>
          </div>
        </div>
        <div class="alert alert-warning">
          <p>⚠️ Importante: El estudiante debe cambiar su contraseña en su primer inicio de sesión.</p>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-primario" (click)="cerrarModalCredenciales()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div>